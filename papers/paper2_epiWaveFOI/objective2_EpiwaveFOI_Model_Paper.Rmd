---
title: "Objective Two — Vector-Informed Epiwave FOI Model (Methods & Framing)"
author: "Ernest Moyo"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
    df_print: paged
  word_document: default
  pdf_document: default
fontsize: 11pt
geometry: margin=1in
---

# Introduction

-   **Problem & burden — why vectors/resistance matter now.**
    -   Malaria risk is **heterogeneous in space and time**.
    -   **Intervention impact is increasingly modulated by vector ecology and insecticide resistance.**
    -   **Maps driven only by cases and coarse environmental covariates underperform when vector dynamics shift quickly, undermining timely and efficient targeting.**
    -   **Heterogeneity is driven by VD.**
-   **Integrating ento data into malaria epi mapping**
    -   **Map based on epi data, integrating entomological data as first‑class inputs.**
    -   Elevate **vector dynamics (VD)** so that **mosquito abundance** $m(t,s)$, human biting rate $a(t,s)$, and mosquito death rate $g(t,s)$ are **data‑linked and time‑varying** within the FOI mapping workflow.
    -   Keep **epi observation model** intact while **linking VD to FOI** through covariates, interventions, and resistance.
-   **What’s been tried (SDMs → mechanistic → hybrids) & limits here.**
    -   **Species‑distribution models capture niches but not transmission mechanics**.
    -   **Fully mechanistic models often ignore spatial covariates or are too slow for mapping**.
    -   **Hybrids seldom give vectors first‑class status and rarely propagate uncertainty into FOI surfaces at ward/pixel scale.**
-   **Gap.**
    -   **No operational, program‑specific framework** that:
        1.  **Models** $m,a,g$ as covariate‑linked, intervention‑ and resistance‑modified processes,
        2.  **Stress‑tests seasonal extremes for numerical robustness,** and
        3.  **Outputs FOI surfaces with quantified uncertainty** usable for programme timing/targeting.
    -   **Objective:** **Develop and validate a vector‑informed FOI mapping module** that **elevates** $m(t,s), a(t,s), g(t,s)$ as data‑linked, time‑varying processes and **plugs them into a national mapping workflow**.
-   **Contribution (one crisp sentence).**
    -   **We introduce a fast, vector‑informed FOI mapping module that treats mosquito abundance, biting rate, and death rate as covariate‑linked, intervention‑ and resistance‑modified processes, producing policy‑ready FOI maps with uncertainty for Tanzania.**
-   **Model**
    -   **Ross–Macdonald FOI core** with **VD (**$m,a,g$) linked to covariates, interventions, and resistance.
    -   **Numerically robust** under seasonal extremes relevant to programme calendars.
-   **Simulation**
    -   **Demonstrate** recovery of FOI and intervention effects under **shifting VD** compared with **case‑only / coarse‑covariate baselines**.
    -   **Propagate uncertainty** from VD through to FOI surfaces.
-   **Case study**
    -   **Developed the model — introducing VD.**
    -   **Demonstrated** it with a **case study in Tanzania**, producing **policy‑ready FOI maps with uncertainty** and illustrating **programme timing/targeting** use.

# Methods

-   **Model**
    -   **Maths (what's there already)** — keep the EpiWave mapping observation model unchanged; **only** the transmission process (FOI) is upgraded to be **vector‑informed** with $m,a,g$ time‑ and space‑varying.
-   **Simulation estimation study**
    -   *(We are already doing this ad‑hoc.)*
    -   Goal: **How well can you recover the parameters** and FOI/incidence when data are simulated from known $m(t,s),a(t,s),g(t,s)$ and interventions.
-   **Case study**
    -   **Tanzania**; **low‑response/simple** setup, focusing on interventions and publicly available MAP layers (e.g., **ITNs**, IRS) — **as simple as possible, as complicated as necessary** to illustrate the workflow.

## Model Description

### Data types (what the model can use)

-   **Observation data (response):** monthly **cases** ($C$) and optional **prevalence** clusters ($Y,N$).
-   **Vector / entomology (drivers of VD):** abundance/proxy layers, micro‑climate–derived survival, bioassay **resistance** indices, ITN/IRS **coverage/use**.
-   **Environment:** rainfall, temperature, humidity, NDVI, elevation (harmonised to grid/time).

### Observation models (same as EpiWave; brief recap)

-   **Cases (admin unit** $l$, month $t$): $$
    C_{l,t}\sim \mathrm{Poisson}\!\big(\gamma_l I_{l,t}\big),\quad
    \gamma_l>0\ \text{(reporting/symptomatic rate; optionally hierarchical)}.
    $$ Pixel‑to‑admin aggregation via population weights; $I_{l,t}$ is **latent incidence** linked below.
-   **Prevalence (optional):** $$
    Y_{l,t}\sim \mathrm{Binomial}\!\big(N_{l,t}, p_{l,t}\big),\qquad
    p_{l,t}\ \text{linked to latent incidence or auxiliary state.}
    $$

> **Connector (mindful of notation):** we define the **force of infection** $\xi_{t,s}$ (per‑person per‑day) from the transmission block below, and use standard EpiWave mappings to connect $\xi$ → **incidence** $I$ → **cases** $C$ (and optionally to **prevalence** $p$) without altering the observation likelihoods.

### Transmission block (Ross–Macdonald + FOI; VD elevated)

We use a two‑compartment vector–host kernel with **time‑ and space‑varying** vector processes: $$
\frac{dx_{t,s}}{dt}= m_{t,s}\,a_{t,s}\,b\,z_{t,s}\,(1-x_{t,s})- r\,x_{t,s},\qquad
\frac{dz_{t,s}}{dt}= a_{t,s}\,c\,x_{t,s}\,(1-z_{t,s})- g_{t,s}\,z_{t,s},
$$ with **FOI** $$
\xi_{t,s} \equiv m_{t,s}\,a_{t,s}\,b\,z_{t,s}.
$$ We hold $b,c,r$ constant in v1; novelty concentrates on $m_{t,s}, a_{t,s}, g_{t,s}$.

#### Supports (parameter domains)

$$
m_{t,s}>0,\qquad a_{t,s}\in(0,1]\ \text{(first‑bite convention)},\qquad g_{t,s}>0.
$$

### Covariate‑linked vector processes

#### Mosquito abundance $m_{t,s}$

Baseline $m^{\ast}_{t,s}$ (e.g., Vector‑Atlas/HLC‑proportional outputs) scaled by covariates and interventions: $$
m_{t,s} \;=\; m^{\ast}_{t,s}\,\exp\!\big(X^{(m)}_{t,s}\,\beta_m\big)\,
\underbrace{\Big[(1-n_{t,s}) + n_{t,s}\,(1-\pi^{(m)}_{t,s})\Big]}_{\text{ITN population‑reduction factor}},
$$ where $n_{t,s}\in[0,1]$ is net use/coverage and $\pi^{(m)}_{t,s}\in[0,1]$ is the **fractional reduction among net‑encountering mosquitoes**; resistance modifies effectiveness via susceptibility $u_{t,s}$: $$
\pi^{(m)}_{t,s} = u_{t,s}\,\pi^{(m)}_{0},\qquad u_{t,s}\in[0,1].
$$

#### Biting rate $a_{t,s}$

Start with constant baseline $a_0$ (no interventions), then ITN‑mediated feeding inhibition with resistance modification: $$
a_{t,s} \;=\; a_0\,\Big(1 - n_{t,s}\,u_{t,s}\,\rho^{(a)}\Big),\qquad \rho^{(a)}\in(0,1).
$$

#### Mosquito death rate $g_{t,s}$

From survival over $\Delta t$ with micro‑climate drivers: $$
g^{\ast}_{t,s} = -\frac{1}{\Delta t}\ln S_{\Delta t}\!\big(T_{t,s}, H_{t,s},\ldots\big),\qquad
g_{t,s} = g^{\ast}_{t,s}\,\Big(1 + n_{t,s}\,u_{t,s}\,\rho^{(g)}\Big),\ \ \rho^{(g)}>0.
$$ (IRS terms analogous if included.)

### Spatial FOI layer with residual GP

To capture residual structure beyond covariates: $$
\log \xi_{t,s}
= \log\!\big(m_{t,s}a_{t,s}b z_{t,s}\big) + \varepsilon_{t,s},\qquad
\varepsilon_{\cdot,\cdot}\sim \mathcal{GP}\!\big(0, K_\theta((t,s),(t',s'))\big),
$$ with Matérn/RBF kernels; $\theta$ with weakly‑informative priors.

### Hierarchical structure, priors & constraints (minimal v1)

-   **Coefficients:** $\beta_m\sim \mathcal N(0,\sigma^2)$; $\rho^{(a)},\rho^{(g)}$ on $(0,1)$ via Beta; $a_0\in(0,1]$.
-   **Kernel hyper‑params:** half‑normals / half‑Cauchy on scales; positivity via log/softplus links.
-   **Constants:** $b,c,r$ fixed in v1 (sensitivity later).

### Computation

-   **Numerics:** explicit Euler / adaptive RK for ODEs with $\Delta t$ in **days**; step‑size tested for stability under seasonal extremes.
-   **Inference:** **HMC** (e.g., NUTS) on the joint posterior; diagnostics via $\widehat R$, ESS, and posterior predictive checks; sparse‑GP if needed for scale.

## Data (inclusion/exclusion)

-   **Entomology/vector:** curated abundance/proxy layers (Vector‑Atlas‑style outputs), micro‑climate survival probabilities, bioassay resistance indices, ITN/IRS coverage and use.
-   **Epidemiology:** routine case time series (e.g., DHIS2), optional prevalence clusters for calibration.
-   **Environment:** rainfall, temperature, humidity, NDVI, elevation; harmonised to a common grid/time base.
-   **Exclusions:** locations with poor geolocation fidelity; months with known reporting outages.

## Pre‑processing

Spatial harmonisation (project/aggregate to grid), temporal alignment (monthly), QA/QC (range checks, duplicates, plausible bounds), and bias correction where sampling is spatially clustered.

## Simulation estimation study

-   **Design.** Simulate $S$ sites over $T$ months with **known** $m_{t,s},a_{t,s},g_{t,s}$; impose **seasonality** and **intervention trajectories** (ITN/IRS) with resistance $u_{t,s}$.
-   **Truth generation.** Solve the ODEs for $(x_{t,s},z_{t,s})$; compute $\xi_{t,s}=m_{t,s}a_{t,s}b z_{t,s}$; generate **cases** and (optionally) **prevalence** via the observation models.
-   **Fitting.** Treat simulated outputs as “observed”; fit **(i)** the proposed VD‑informed FOI model and **(ii)** a correlative baseline (e.g., EpiWave‑mapping with spatial GP, no VD), holding observation models identical.
-   **Recovery metrics.** Compare posterior means/intervals to truth for **FOI** $\xi$, **incidence** $I$, and intervention effects; summarise RMSE/CRPS, calibration curves, and coverage.
-   **Figures.** Site‑level time‑series overlays (truth vs. models), plus aggregated error summaries.

## Case study (Tanzania; simple & illustrative)

-   **Scope.** Country‑level demonstration with **public covariates** (MAP ITN/IRS layers, environmental rasters) and an available **monthly case** series; **low spatial resolution** (e.g., \~10km) for speed.
-   **Tweaks for Tz.** Use existing EpiWave **catchment/aggregation** options as needed; adopt a simple prevalence–incidence relationship; keep $b,c,r$ fixed.
-   **Fitting.** Run HMC with modest chains/iter until ESS & $\widehat R$ good; produce **posterior mean** and **uncertainty maps** for FOI/incidence.
-   **Counterfactuals.** Using posterior draws, compute maps for **no‑ITN/IRS** and **expanded ITN** scenarios (illustrative only).

## Software & reproducibility

-   **Code.** Repositories: `epiwave-foi-model` (this module) and `epiwave.mapping` (baseline mapping). Version, seeds, and package/session info recorded.
-   **Data.** Public layers cited in text; any restricted case data acknowledged and used per agreement.

# Results

> **Note:** Keep wording minimal and tailored. This file is a **skeleton** with code stubs—drop in your actual fitted objects / CSVs from `epiwave-foi-model` and `epiwave.mapping` runs.

## Model (done already above)

-   See Methods for model description; here we only **report outputs**.

## Simulation estimation study

-   **Setup.** Simulate **10 different sites** (or use your already-simulated set) with known $m,a,g$ and intervention trajectories; fit:
    -   **VD-informed FOI** (this work), and
    -   **Baseline mapping** (e.g., correlative/GP without VD).
-   **Goal.** Show **why the new method works** vs. alternatives; **unpack** performance further (error, coverage, calibration).

### A. Accuracy at site level (bar charts: Actual vs. Estimates)

-   **Bar charts** comparing **true** vs **estimated** FOI/incidence, aggregated over time (or end-of-period).

```{r setup, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r results-bars-placeholder, eval=FALSE}
# TODO: replace this placeholder with your real results data frame
# Expected columns:
# site_id, metric, truth, vd_mean, vd_lwr, vd_upr, base_mean, base_lwr, base_upr

set.seed(1)
sites <- paste0("S", sprintf("%02d", 1:10))
df <- tibble(
  site_id = rep(sites, each = 1),
  metric  = "FOI_mean",
  truth   = runif(10, 0.02, 0.20),
  vd_mean = truth * runif(10, 0.9, 1.1),
  vd_lwr  = vd_mean * 0.85,
  vd_upr  = vd_mean * 1.15,
  base_mean = truth * runif(10, 0.6, 1.5),
  base_lwr  = base_mean * 0.75,
  base_upr  = base_mean * 1.25
)

df_long <- df %>%
  select(site_id, truth, vd_mean, base_mean) %>%
  pivot_longer(-site_id, names_to = "model", values_to = "value") %>%
  mutate(model = factor(model, levels = c("truth","vd_mean","base_mean"),
                        labels = c("Truth","VD-informed","Baseline")))

ggplot(df_long, aes(x = site_id, y = value, fill = model)) +
  geom_col(position = position_dodge(width = 0.75), width = 0.7) +
  labs(x = "Site", y = "FOI (aggregated)", fill = "", 
       title = "Simulation: Truth vs Estimates (10 sites)") +
  theme_minimal()
```

### B. Error, coverage, calibration (tailor-made to show *why* our method works)

```{r results-metrics-placeholder, eval=FALSE}
# TODO: supply posterior intervals per site to compute errors and coverage
metrics <- df %>%
  transmute(
    site_id,
    abs_err_vd   = abs(vd_mean - truth),
    abs_err_base = abs(base_mean - truth),
    rel_err_vd   = abs_err_vd / pmax(truth, 1e-6),
    rel_err_base = abs_err_base / pmax(truth, 1e-6)
  )

metrics %>%
  summarise(across(starts_with("abs_err_"), mean), 
            across(starts_with("rel_err_"), mean))
```

-   **Unpack further:** add CRPS, PIT/coverage diagnostics, and show **per-site** performance tables.

## Case study

-   **Scenarios:**
    1.  **Cases (observed)** — status quo.
    2.  **Cases with no interventions** — counterfactual (e.g., set ITN/IRS to zero).
    3.  **Cases with full interventions** — counterfactual (e.g., high ITN/IRS).
-   **Outputs to show:**
    -   **Time series** (national or selected admin) for all three scenarios.
    -   **Spatial maps** (optional) of posterior mean and uncertainty.
    -   **Picking a site** — highlight one site to illustrate **space × time** behaviour.

### A. Time series (observed vs. counterfactuals)

```{r case-ts-placeholder, eval=FALSE}
# TODO: load case study draws/means for three scenarios at a chosen admin or pixel
# Expected columns: date, cases_obs, cases_no_int, cases_full_int

library(lubridate)

ts_df <- tibble(
  date = seq(as.Date("2023-01-01"), by = "month", length.out = 24),
  cases_obs     = round(exp(sin((1:24)/3)) * 100 + rnorm(24,0,10)),
  cases_no_int  = round(exp(sin((1:24)/3)) * 130 + rnorm(24,0,12)),
  cases_full_int= round(exp(sin((1:24)/3)) * 70 + rnorm(24,0,8))
) %>%
  pivot_longer(-date, names_to = "scenario", values_to = "cases") %>%
  mutate(scenario = factor(scenario,
                           levels = c("cases_obs","cases_no_int","cases_full_int"),
                           labels = c("Observed","No interventions","Full interventions")))

ggplot(ts_df, aes(date, cases, group = scenario, linetype = scenario)) +
  geom_line(size = 1) +
  labs(x = NULL, y = "Cases (monthly)",
       title = "Case study: Time series under observed and counterfactual scenarios",
       linetype = "") +
  theme_minimal()
```

### B. Picking a site (space × time illustration)

```{r case-pick-site-placeholder, eval=FALSE}
# TODO: choose one site (admin/pixel) and plot posterior mean + intervals
# Expected columns: date, site_id, cases_mean, cases_lwr, cases_upr, scenario

site_id_pick <- "S05"  # <-- replace with real admin/pixel label
site_ts <- tibble(
  date = seq(as.Date("2023-01-01"), by = "month", length.out = 24),
  site_id = site_id_pick,
  scenario = "Observed",
  cases_mean = seq(90, 140, length.out = 24),
  cases_lwr  = cases_mean * 0.8,
  cases_upr  = cases_mean * 1.2
)

ggplot(site_ts, aes(date, cases_mean)) +
  geom_ribbon(aes(ymin = cases_lwr, ymax = cases_upr), alpha = 0.2) +
  geom_line() +
  labs(x = NULL, y = "Cases",
       title = paste("Selected site:", site_id_pick, "— posterior mean & 80% interval")) +
  theme_minimal()
```

### C. Notes (keep simple, then deepen only as needed)

-   Start **simple** (one admin, short horizon) then **as complicated as necessary** (more sites, longer horizon, spatial maps).
-   Use **same observation model** across scenarios; differences arise from **VD-informed FOI** vs baseline and from **intervention settings**.
-   Report **posterior mean** and **uncertainty**; avoid over-explaining in main text—move details to supplement.

# Discussion

## What’s new

-   **Vector-first FOI mapping** with interpretable links from **interventions & resistance** to $m,a,g$.
-   **More information, but not doing everything** — deliberately **minimal v1** that elevates VD while **keeping observation models unchanged**.
-   **Operational framing**: designed to plug into mapping workflows and produce **uncertainty-aware FOI surfaces** at program scales.

## How it compares / extends

-   **Hybridisation** of a **mechanistic Ross–Macdonald kernel** (VD → FOI) with a **spatial GP** for residual structure and **programmatic covariates** (ITNs/IRS, resistance, environment).
-   Extends case-only or coarse-covariate approaches by making $m(t,s),a(t,s),g(t,s)$ first-class, data-linked processes.

## Policy

-   **Data needs:** better **ento maps** (abundance/proxies), **bioassay resistance** time series, **micro-climate** survival surfaces; routine **case** time series with QA.
-   **Timing/targeting guidance, uncertainty-aware:** FOI maps with **posterior intervals** to schedule **seasonal operations** and support **subnational tailoring**.
-   **Subnational tailoring:** ward/pixel FOI for **local prioritisation**; allow **programme-specific constraints** (logistics, budgets).
-   **Practical next steps (Tanzania):** run a **mini-case at ward scale** and prepare an **operational hand-off** (e.g., dashboard exporting FOI & counterfactuals).
-   **Rich outputs:** can make maps of **everything** — $m,a,g$, FOI, incidence, and **intervention counterfactuals** (observed / no interventions / full interventions).

## Limits

-   **Data gaps & identifiability trade-offs:** sparse ento, noisy resistance proxies (hut-design differences, assay variability) can limit separate identification of $m,a,g$ pathways.
-   **Level of technical ability of the user:** tuning priors/solvers and reading uncertainty maps may require **analyst support**.
-   **Relatively more interpretable** than black-box models, but still requires **assumptions** (e.g., fixed $b,c,r$ in v1) and **sensitivity checks**.

## Future

-   **Richer temporal dynamics:** allow **lagged intervention effects**, **non-stationary seasonality**, and **dynamic** $b,c,r$.
-   **Multiple vectors:** species-specific $m^{(k)},a^{(k)},g^{(k)}$ with mixture FOI; integrate **behavioral shifts**.
-   **Pan-African scaling:** harmonised inputs and **efficient inference** (e.g., amortised or sparse methods) for continental runs.
-   **Tooling:** reproducible pipelines, **dashboards** for programme users, and **APIs** for periodic updates.

## (Optional) Review of inferential methods

-   **Current choice:** HMC/NUTS for joint posterior; sparse GP if needed.
-   **Alternatives:** variational approximations, **amortised inference** (learned surrogates) for speed; **particle approaches** for non-Gaussian/latent-state extensions.
-   **When to extend:** larger spatial grids, multi-species models, or when **turnaround** is critical for operational timing.


# Conclusion

- **Take‑home (one sentence).**  
  We present a **fast, vector-informed FOI module** that elevates $m,a,g$ as covariate-linked, intervention- and resistance-modified processes and yields policy-ready FOI maps with uncertainty for Tanzania./ We deliver a **vector‑first FOI mapping module** that links **interventions and resistance to $m,a,g$**, producing **policy‑ready FOI maps with quantified uncertainty** that slot into existing EpiWave workflows.

- **What we contributed.**
  - Elevated **mosquito abundance $m(t,s)$, biting rate $a(t,s)$, and death rate $g(t,s)$** to **data‑linked, time‑varying** drivers of FOI.
  - Kept **observation models unchanged**, upgrading only the **transmission block** (Ross–Macdonald + VD) and adding a **residual spatial GP** where needed.
  - Provided a **minimal v1** that is interpretable, robust under seasonality, and ready for programme‑scale mapping.

- **What the evidence shows (this paper).**
  - **Simulation estimation study:** across **10 sites**, the VD‑informed model **recovers FOI/incidence and intervention effects** more reliably than a correlative baseline (truth vs. estimates; error/coverage).
  - **Case study (Tanzania):** generated **FOI/incidence maps with uncertainty** and simple **counterfactuals** (observed / **no interventions** / **full interventions**), demonstrating **timing/targeting** utility.

- **Policy implications.**
  - Enables **subnational tailoring** and **seasonal scheduling** using **uncertainty‑aware** FOI layers.
  - Clarifies **data needs** (ento proxies, resistance time series, micro‑climate survival, routine cases with QA) for sustained operational use.

- **Limitations to keep in view.**
  - **Data gaps & identifiability trade‑offs** (resistance proxies, hut design, sparse ento).
  - **Assumptions in v1** (fixed $b,c,r$); potential **computational cost** when scaling GPs/ODEs.
  - **User capability:** interpreting uncertainty and tuning priors/solvers may require analyst support.

- **Immediate next steps.**
  - **Tanzania mini‑case at ward scale** with operational **hand‑off** (dashboard/API).
  - Add **IRS terms** where available, and expand to **multiple vectors** when data permit.
  - Explore **amortised/sparse inference** for faster national reruns.

- **Looking ahead.**
  - Richer temporal dynamics (lags, non‑stationarity), species mixtures, and **pan‑African scaling** with harmonised inputs and reproducible pipelines.

